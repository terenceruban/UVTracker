<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vitamin D Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4CAF50" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; background:#f4f4f4; color:#333; }
    header { background:#4CAF50; color:white; padding:15px; text-align:center; font-size:1.2em; }
    .container { padding:15px; }
    .card { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    label { font-weight:bold; display:block; margin-top:10px; }
    input, select { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:8px; font-size:1em; }
    button { width:100%; background:#4CAF50; color:white; padding:12px; margin-top:15px; border:none; border-radius:8px; font-size:1em; cursor:pointer; }
    button:hover { background:#45a049; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #ddd; font-size:0.9em; text-align:center; }
    th { background:#4CAF50; color:white; }
    .actions button { padding:5px; margin:2px; font-size:0.8em; }
  </style>
  <script>
    let db;
    const skinFactors = { I:1.0, II:0.9, III:0.75, IV:0.6, V:0.4, VI:0.2 };

    document.addEventListener("DOMContentLoaded", () => {
      let request = indexedDB.open("VitaminDDB", 2);
      request.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("sessions")) {
          db.createObjectStore("sessions", { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = e => { db = e.target.result; loadSessions(); };

      document.getElementById("trackerForm").addEventListener("submit", saveSession);
      document.getElementById("downloadCSV").addEventListener("click", downloadCSV);
    });

    async function fetchUVIndex(date, time, lat, lon) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=uv_index&start_date=${date}&end_date=${date}`;
        let response = await fetch(url);
        let data = await response.json();
        let hour = parseInt(time.split(":")[0]);
        return data.hourly.uv_index[hour];
      } catch (e) { console.error("UV fetch error", e); return null; }
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({lat:pos.coords.latitude, lon:pos.coords.longitude}),
          err => reject(err)
        );
      });
    }

    async function saveSession(e) {
      e.preventDefault();
      let date = document.getElementById("date").value;
      let start = document.getElementById("start").value;
      let end = document.getElementById("end").value;
      let uv = document.getElementById("uv").value;
      let skin = document.getElementById("skin").value;

      // calc duration
      let [sh, sm] = start.split(":").map(Number);
      let [eh, em] = end.split(":").map(Number);
      let duration = (eh*60+em) - (sh*60+sm);
      if (duration < 0) duration += 1440; // overnight case

      // fetch UV if not entered
      if (!uv) {
        try {
          let {lat, lon} = await getLocation();
          uv = await fetchUVIndex(date, start, lat, lon);
        } catch { uv = null; }
      }
      uv = parseFloat(uv || 0);

      // calc Vitamin D IU (rough)
      let iu = Math.round(uv * duration * skinFactors[skin]);

      let tx = db.transaction("sessions", "readwrite");
      let store = tx.objectStore("sessions");
      store.add({ date, start, end, uv, skin, duration, iu });
      tx.oncomplete = () => loadSessions();

      document.getElementById("trackerForm").reset();
    }

    function loadSessions() {
      let tx = db.transaction("sessions", "readonly");
      let store = tx.objectStore("sessions");
      let req = store.getAll();
      req.onsuccess = () => {
        let sessions = req.result;
        let table = document.getElementById("dataTable");
        table.innerHTML = "<tr><th>Date</th><th>Start</th><th>End</th><th>UV</th><th>Skin</th><th>Duration (min)</th><th>Vit D (IU)</th><th>Actions</th></tr>";
        sessions.forEach(s => {
          table.innerHTML += `<tr>
            <td>${s.date}</td><td>${s.start}</td><td>${s.end}</td>
            <td>${s.uv ?? ""}</td><td>${s.skin}</td><td>${s.duration}</td><td>${s.iu}</td>
            <td class="actions">
              <button onclick="deleteSession(${s.id})">‚ùå</button>
            </td>
          </tr>`;
        });
      };
    }

    function deleteSession(id) {
      let tx = db.transaction("sessions", "readwrite");
      let store = tx.objectStore("sessions");
      store.delete(id);
      tx.oncomplete = () => loadSessions();
    }

    function downloadCSV() {
      let tx = db.transaction("sessions", "readonly");
      let store = tx.objectStore("sessions");
      let req = store.getAll();
      req.onsuccess = () => {
        let sessions = req.result;
        let csv = "Date,Start,End,UV,Skin,Duration,VitD_IU\\n";
        sessions.forEach(s => {
          csv += `${s.date},${s.start},${s.end},${s.uv},${s.skin},${s.duration},${s.iu}\\n`;
        });
        let blob = new Blob([csv], { type:"text/csv" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "vitaminD.csv";
        a.click();
      };
    }
  </script>
</head>
<body>
  <header>üåû Vitamin D Tracker</header>
  <div class="container">
    <div class="card">
      <form id="trackerForm">
        <label>Date: <input type="date" id="date" required></label>
        <label>Start Time: <input type="time" id="start" required></label>
        <label>End Time: <input type="time" id="end" required></label>
        <label>Skin Type:
          <select id="skin" required>
            <option value="I">I - Very Fair</option>
            <option value="II">II - Fair</option>
            <option value="III" selected>III - Medium</option>
            <option value="IV">IV - Olive</option>
            <option value="V">V - Brown</option>
            <option value="VI">VI - Dark Brown/Black</option>
          </select>
        </label>
        <label>UV Index (leave empty for auto): <input type="number" step="0.1" id="uv"></label>
        <button type="submit">‚ûï Save Session</button>
      </form>
    </div>
    <div class="card">
      <button id="downloadCSV">‚¨áÔ∏è Export CSV</button>
      <table id="dataTable"></table>
    </div>
  </div>
</body>
</html>
